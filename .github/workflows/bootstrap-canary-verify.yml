name: Bootstrap Canary Verify

on:
  workflow_dispatch:
    inputs:
      bootstrap_base_url:
        description: 'Bootstrap base URL (required), e.g. https://.../releases/download/<tag>'
        required: true
      package_variant:
        description: 'Termux package variant'
        required: false
        default: 'apt-android-7'

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v6

      - name: Setup java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build with strict bootstrap gates
        shell: bash {0}
        env:
          BOTDROP_BOOTSTRAP_BASE_URL: ${{ github.event.inputs.bootstrap_base_url }}
          BOTDROP_BOOTSTRAP_REQUIRE_ADB: "1"
          BOTDROP_BOOTSTRAP_FAIL_ON_LEGACY_PATHS: "1"
          TERMUX_PACKAGE_VARIANT: ${{ github.event.inputs.package_variant }}
        run: |
          set -e
          echo "Running strict canary verification against:"
          echo "  BOTDROP_BOOTSTRAP_BASE_URL=$BOTDROP_BOOTSTRAP_BASE_URL"
          ./gradlew clean :app:assembleDebug
          scripts/audit_bootstrap.sh app/src/main/cpp/bootstrap-aarch64.zip
